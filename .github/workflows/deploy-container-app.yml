name: Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  RESOURCE_GROUP: recipe-maker-rg
  APP_NAME: recipe-maker-container
  LOCATION: centralus
  REGISTRY: recipecontainerregistry
  IMAGE_NAME: recipe-maker-app
  COSMOS_ACCOUNT: recipe-maker-cosmos
  INSIGHTS_NAME: recipe-maker-insights

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ env.REGISTRY }}

      - name: Get Cosmos DB connection string
        id: cosmos
        run: |
          CONN=$(az cosmosdb keys list \
            --name ${{ env.COSMOS_ACCOUNT }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --type connection-strings \
            --query "connectionStrings[?description=='Primary MongoDB Connection String'].connectionString" \
            --output tsv)
          # Add database name to connection string
          CONN="${CONN/10255\//10255\/recipe-maker}"
          # Add directConnection=true to disable transactions (Cosmos DB requirement)
          CONN="${CONN}&directConnection=true"
          echo "::add-mask::$CONN"
          echo "connection-string=$CONN" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest,${{ env.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            COSMOS_DB_CONNECTION_STRING=${{ steps.cosmos.outputs.connection-string }}
            # Add directConnection=true to disable transactions (Cosmos DB requirement)
            CONN="${CONN}&directConnection=true"
            echo "::add-mask::$CONN"
            echo "connection-string=$CONN" >> $GITHUB_OUTPUT

      - name: Get Application Insights connection string
        id: insights
        run: |
          CONN=$(az monitor app-insights component show \
            --app ${{ env.INSIGHTS_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "connectionString" \
            --output tsv 2>/dev/null || echo "")
          if [ -n "$CONN" ]; then
            echo "::add-mask::$CONN"
            echo "connection-string=$CONN" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Container Apps
        run: |
          # Set secrets first (including OAuth credentials)
          az containerapp secret set \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --secrets \
              cosmos-connection="${{ steps.cosmos.outputs.connection-string }}" \
              insights-connection="${{ steps.insights.outputs.connection-string }}" \
              auth-secret="${{ secrets.AUTH_SECRET }}" \
              google-client-id="${{ secrets.GOOGLE_CLIENT_ID }}" \
              google-client-secret="${{ secrets.GOOGLE_CLIENT_SECRET }}" 2>/dev/null || true

          # Update existing app or create new one
          # Note: ACA will map external port to internal port 80 (nginx)
          az containerapp update \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --set-env-vars \
              COSMOS_DB_CONNECTION_STRING=secretref:cosmos-connection \
              APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:insights-connection \
              AUTH_SECRET=secretref:auth-secret \
              GOOGLE_CLIENT_ID=secretref:google-client-id \
              GOOGLE_CLIENT_SECRET=secretref:google-client-secret \
              AUTH_URL=https://brose-recipes.com \
            --cpu 0.5 \
            --memory 1.0Gi \
            --min-replicas 1 \
            --max-replicas 3 || \
          az containerapp create \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment ${{ env.APP_NAME }}-env \
            --image ${{ env.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --target-port 80 \
            --ingress external \
            --secrets \
              cosmos-connection="${{ steps.cosmos.outputs.connection-string }}" \
              insights-connection="${{ steps.insights.outputs.connection-string }}" \
              auth-secret="${{ secrets.AUTH_SECRET }}" \
              google-client-id="${{ secrets.GOOGLE_CLIENT_ID }}" \
              google-client-secret="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            --env-vars \
              COSMOS_DB_CONNECTION_STRING=secretref:cosmos-connection \
              APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:insights-connection \
              AUTH_SECRET=secretref:auth-secret \
              GOOGLE_CLIENT_ID=secretref:google-client-id \
              GOOGLE_CLIENT_SECRET=secretref:google-client-secret \
              AUTH_URL=https://brose-recipes.com \
            --cpu 1.0 \
            --memory 2.0Gi \
            --min-replicas 1 \
            --max-replicas 3 \
            --registry-server ${{ env.REGISTRY }}.azurecr.io

      - name: Get app URL
        id: app-url
        run: |
          URL=$(az containerapp show \
            --name ${{ env.APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)
          echo "url=https://$URL" >> $GITHUB_OUTPUT
          echo "### Deployment successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App URL:** https://$URL" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Health check:** https://$URL/health" >> $GITHUB_STEP_SUMMARY
          echo "**API Health:** https://$URL/api/health" >> $GITHUB_STEP_SUMMARY
          echo "**MCP Endpoint:** https://$URL/mcp" >> $GITHUB_STEP_SUMMARY

      - name: Test health endpoint
        run: |
          sleep 30  # Wait for container to start
          curl -f ${{ steps.app-url.outputs.url }}/health || echo "Health check failed (app may still be starting)"
